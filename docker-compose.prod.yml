# Docker Compose for Production
# Use: docker-compose -f docker-compose.yml -f docker-compose.prod.yml up

version: '3.8'

services:
  postgres:
    image: postgres:17-alpine
    container_name: cqrs-library-db-prod
    restart: always
    environment:
      - POSTGRES_DB=${POSTGRES_DB:-librarydb}
      - POSTGRES_USER=${POSTGRES_USER:-libraryuser}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-librarypass}
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres_data_prod:/var/lib/postgresql/data
      # Optional: Backup location
      - ./backups:/backups
    networks:
      - library-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-libraryuser} -d ${POSTGRES_DB:-librarydb}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    # Resource limits for production
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G
    # Security options
    security_opt:
      - no-new-privileges:true
    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  library-api:
    build:
      context: .
      dockerfile: Dockerfile.prod
      args:
        BUILD_CONFIGURATION=Release
    container_name: cqrs-library-api-prod
    restart: always
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:8080
      - ConnectionStrings__DefaultConnection=Host=postgres;Database=${POSTGRES_DB:-librarydb};Username=${POSTGRES_USER:-libraryuser};Password=${POSTGRES_PASSWORD:-librarypass}
      # Production-specific settings
      - ASPNETCORE_FORWARDEDHEADERS_ENABLED=true
      - DOTNET_EnableDiagnostics=0
      # Uncomment only for initial seeding
      # - NeedSeed=true
    expose:
      - "8080"
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - library-network
    # Traefik labels for automatic configuration
    labels:
      # Enable Traefik for this service
      - "traefik.enable=true"

      # HTTP Router
      - "traefik.http.routers.library-api.rule=Host(`${DOMAIN:-localhost}`) && PathPrefix(`/api`)"
      - "traefik.http.routers.library-api.entrypoints=websecure"
      - "traefik.http.routers.library-api.tls=true"
      - "traefik.http.routers.library-api.tls.certresolver=letsencrypt"

      # Service configuration
      - "traefik.http.services.library-api.loadbalancer.server.port=8080"
      - "traefik.http.services.library-api.loadbalancer.healthcheck.path=/health"
      - "traefik.http.services.library-api.loadbalancer.healthcheck.interval=30s"

      # Middlewares
      - "traefik.http.routers.library-api.middlewares=api-stripprefix,security-headers,rate-limit,compress"
      - "traefik.http.middlewares.api-stripprefix.stripprefix.prefixes=/api"

      # Network
      - "traefik.docker.network=library-network"

    # Health check
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 40s
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
      # Restart policy
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
    # Security options
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp
    # Logging
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Traefik reverse proxy for production
  traefik:
    image: traefik:v3.0
    container_name: cqrs-library-traefik
    restart: always
    command:
      # Enable Docker provider
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.network=library-network"
      # Entry points
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      # SSL/TLS with Let's Encrypt
      - "--certificatesresolvers.letsencrypt.acme.email=${LETSENCRYPT_EMAIL:-admin@example.com}"
      - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
      - "--certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web"
      # Uncomment for Let's Encrypt staging (testing)
      # - "--certificatesresolvers.letsencrypt.acme.caserver=https://acme-staging-v02.api.letsencrypt.org/directory"
      # Dashboard (optional - secure it!)
      - "--api.dashboard=true"
      # Logging
      - "--log.level=${TRAEFIK_LOG_LEVEL:-INFO}"
      - "--accesslog=true"
      - "--accesslog.format=json"
      # Metrics
      - "--metrics.prometheus=true"
    ports:
      - "80:80"
      - "443:443"
      # Dashboard (optional - only enable with authentication)
      - "8081:8080"
    volumes:
      # Docker socket for service discovery
      - /var/run/docker.sock:/var/run/docker.sock:ro
      # SSL certificates storage
      - traefik_letsencrypt:/letsencrypt
      # Static configuration (optional)
      - ./traefik/traefik.yml:/etc/traefik/traefik.yml:ro
      - ./traefik/dynamic.yml:/etc/traefik/dynamic.yml:ro
    networks:
      - library-network
    labels:
      # Enable Traefik dashboard with authentication
      - "traefik.enable=true"

      # Dashboard router
      - "traefik.http.routers.dashboard.rule=Host(`traefik.${DOMAIN:-localhost}`)"
      - "traefik.http.routers.dashboard.entrypoints=websecure"
      - "traefik.http.routers.dashboard.tls=true"
      - "traefik.http.routers.dashboard.tls.certresolver=letsencrypt"
      - "traefik.http.routers.dashboard.service=api@internal"
      - "traefik.http.routers.dashboard.middlewares=dashboard-auth"

      # Dashboard authentication (change credentials!)
      # Generate with: htpasswd -nb admin password
      - "traefik.http.middlewares.dashboard-auth.basicauth.users=admin:$$apr1$$H6uskkkW$$IgXLP6ewTrSuBkTrqE8wj/"

      # HTTP to HTTPS redirect
      - "traefik.http.routers.http-catchall.rule=hostregexp(`{host:.+}`)"
      - "traefik.http.routers.http-catchall.entrypoints=web"
      - "traefik.http.routers.http-catchall.middlewares=redirect-to-https"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.permanent=true"
    healthcheck:
      test: ["CMD", "traefik", "healthcheck", "--ping"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 5s
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 128M
        reservations:
          cpus: '0.25'
          memory: 64M
    security_opt:
      - no-new-privileges:true
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

volumes:
  postgres_data_prod:
    driver: local
  traefik_letsencrypt:
    driver: local

networks:
  library-network:
    driver: bridge
